name: Auto Version & Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'VERSION'
      - 'pyproject.toml'
      - '*/__init__.py'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # --- SMART SKIPPING ---
      - name: Check skip conditions
        id: check_skip
        run: |
          MSG=$(git log -1 --pretty=%B)
          AUTHOR=$(git log -1 --pretty=%an)
          if [[ "$MSG" == *"[skip ci]"* ]] || [[ "$MSG" == *"[skip-version]"* ]] || [[ "$AUTHOR" == "github-actions"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
          fi

      - name: Setup Python
        if: steps.check_skip.outputs.skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --- SAFETY CHECKS (Only runs if python tests exist) ---
      - name: Install dependencies & Test
        if: steps.check_skip.outputs.skip == 'false'
        run: |
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -d "tests" ]; then pytest tests/; fi

      # --- DETERMINE BUMP TYPE ---
      - name: Determine version bump
        if: steps.check_skip.outputs.skip == 'false'
        id: bump_type
        run: |
          MSG=$(git log -1 --pretty=%B)
          if [[ "$MSG" == *BREAKING* ]] || [[ "$MSG" == *!:* ]]; then
            echo "type=major" >> $GITHUB_OUTPUT
            echo "ðŸš¨ Detected BREAKING CHANGE - Bumping MAJOR"
          elif [[ "$MSG" == feat:* ]] || [[ "$MSG" == feat\(* ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "âœ¨ Detected Feature - Bumping MINOR"
          else
            echo "type=patch" >> $GITHUB_OUTPUT
            echo "ðŸ©¹ Detected Fix/Other - Bumping PATCH"
          fi

      # --- INCREMENT VERSION ---
      - name: Increment Version
        if: steps.check_skip.outputs.skip == 'false'
        id: version
        run: |
          cat > bump_version.py << 'EOF'
          import re, sys, os
          from pathlib import Path

          def parse(v): return list(map(int, v.strip().lstrip('v').split('.')))

          def bump(v, type):
              major, minor, patch = parse(v)
              if type == 'major': return f"{major+1}.0.0"
              if type == 'minor': return f"{major}.{minor+1}.0"
              return f"{major}.{minor}.{patch+1}"

          # Detect File
          files = {"pyproject.toml": 'version = "', "setup.py": 'version="', "VERSION": ""}
          target, pattern = next(((f, p) for f, p in files.items() if Path(f).exists()), (None, None))

          if not target:
              print("No version file found. Creating VERSION."); Path("VERSION").write_text("1.0.0"); target="VERSION"
              current, new = "0.0.0", "1.0.0"
          else:
              content = Path(target).read_text()
              if target == "VERSION":
                  current = content.strip()
                  new = bump(current, sys.argv[1])
                  Path(target).write_text(new)
              else:
                  # Regex for pyproject/setup
                  match = re.search(r'version\s*=\s*["\']([^"\']+)["\']', content)
                  current = match.group(1)
                  new = bump(current, sys.argv[1])
                  new_content = re.sub(r'(version\s*=\s*["\'])([^"\']+)["\']', rf'\1{new}\2', content)
                  Path(target).write_text(new_content)

          print(f"::set-output name=old_version::{current}")
          print(f"::set-output name=new_version::{new}")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"new_version={new}\nold_version={current}\n")
          EOF

          python bump_version.py ${{ steps.bump_type.outputs.type }}

      - name: Commit & Tag
        if: steps.check_skip.outputs.skip == 'false'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "chore: bump to v${{ steps.version.outputs.new_version }} [skip ci]"
          git tag "v${{ steps.version.outputs.new_version }}"
          git push origin main --tags

      - name: Create Release
        if: steps.check_skip.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.new_version }}" \
            --title "v${{ steps.version.outputs.new_version }}" \
            --generate-notes
